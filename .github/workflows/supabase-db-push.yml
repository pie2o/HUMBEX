name: CI â€” Push Supabase DB

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  supabase-db-push:
    name: Apply Supabase migrations & seed
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show runner info (debug)
        run: |
          uname -a
          lsb_release -a || true

      - name: Setup Node.js (compatible with Supabase CLI)
        uses: actions/setup-node@v4
        with:
          # use a Node version that satisfies Supabase CLI: >=20.17.0 or >=22.9.0
          node-version: '20.x'

      - name: Print Node & npm versions (debug)
        run: |
          node -v
          npm -v

      - name: Install Supabase CLI (global)
        # With Node >= 20.17.0 this should succeed
        run: npm install -g supabase@latest

      - name: Link Supabase project
        env:
          SUPABASE_REF: ${{ secrets.SUPABASE_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          npx supabase --version
          npx supabase link --project-ref "$SUPABASE_REF"

      - name: Push migrations and seed
        env:
          SUPABASE_REF: ${{ secrets.SUPABASE_REF }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          npx supabase db push --include-all --include-seed
